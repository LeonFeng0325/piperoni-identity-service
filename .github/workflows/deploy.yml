name: 'Deploy to EC2'

on:
    workflow_dispatch:

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
            - name: Deploy to EC2
              run: |
                echo "$KEY" > key.pem
                ssh -i key.pem -T ec2-user@$HOST << EOL
                cd piperoni-identity-service
                git checkout $BRANCH
                git pull
                sudo docker-compose down
                sudo docker-compose build --no-cache
                sudo docker-compose up -d
                EOL
              env:
                    KEY: ${{ secrets.SSH_KEY }}
                    HOST: ${{ secrets.INSTANCE_URL }}
                    BRANCH: ${{ github.ref_name }}